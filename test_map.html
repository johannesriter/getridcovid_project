<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Find Your Hospital</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- lets load Leaflet's .js and .css from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>  

  <!-- Load Esri Leaflet from CDN.  it has no .css stylesheet of its own, only .js -->
  <script src="https://unpkg.com/esri-leaflet@3.0.2/dist/esri-leaflet.js"
    integrity="sha512-myckXhaJsP7Q7MZva03Tfme/MSF5a6HC2xryjAM4FxPLHGqlh5VALCbywHnzs2uPoF/4G/QVXyYDDSkp5nPfig=="
    crossorigin=""></script>

  <!-- Load Esri Leaflet Geocoder from CDN -->
  <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.css">
  <script src="https://unpkg.com/esri-leaflet-geocoder@3.0.0/dist/esri-leaflet-geocoder.js"></script>

  <!-- Load ArcGIS REST JS from CDN -->
  <script src="https://unpkg.com/@esri/arcgis-rest-request@3.0.0/dist/umd/request.umd.js"></script>
  <script src="https://unpkg.com/@esri/arcgis-rest-routing@3.0.0/dist/umd/routing.umd.js"></script>
  <script src="https://unpkg.com/@esri/arcgis-rest-auth@3.0.0/dist/umd/auth.umd.js"></script>

  <!-- Load Leaflet search control from CDN -->
  <!-- <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->
  <!-- <script src="js/index.js"></script> -->
  <!-- <script src="D:\Training\ESRI_Leaflet\js\controls\search.js"></script> -->

    <style>
        /* html,
        body,
        #map {
          height: 100%;
          width: 100%;
          margin: 0;
          padding: 0;
        } */
        body { margin:0; padding:0; }
        #map {
          position: absolute;
          top:0;
          bottom:0;
          right:0;
          left:0;
          font-family: Arial, Helvetica, sans-serif;
          font-size: 14px;
          color: #323232;
        }
        #directions {
          position: absolute;
          z-index: 1000;
          width: 30%;
          max-height: 50%;
          right: 20px;
          top: 20px;
          overflow-y: auto; /* Show a scrollbar if needed */
          background: white;
          font-family: Arial, Helvetica, Verdana;
          line-height: 1.5;
          font-size: 14px;
          padding: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>

        const apiKey = "AAPK0b65d16e8eb1480bb0033da6c732bf2593Q-jAYP_lwzith1IRs4RVy4lwQtgoWn7dPlBwOHRUPH0wyEf3HMuWJD2I_HGCGO";
        const basemapEnum = "Topographic";
        const map = L.map('map', {
          minZoom: 2
        }).setView([-6.2088,106.8456], 11); // Jakarta

        L.esri.basemapLayer(basemapEnum, {
          apiKey: apiKey
        }).addTo(map);

        // L.easyButton('fa-home',function(btn, map){
        //   var jakarta = {
        //     lat: -6.2088,
        //     lng: 106.8456,
        //     zoom: 12
        //   };
        //   map.setView(jakarta);
        // }).addTo(map);

        // Style hospital
        const icon = L.icon({
          iconUrl: "https://pics.freeicons.io/uploads/icons/png/5554319801578287702-512.png",
          iconSize:[30,30]
        })

        var hospital_jkt = L.esri.featureLayer({
          url: "https://services8.arcgis.com/mpSDBlkEzjS62WgX/ArcGIS/rest/services/Daftar_RumahSakitDKI_JAKARTA_cleansed/FeatureServer/0",
          pointToLayer: (geojson, latlng) => {
            return L.marker(latlng, {
              icon: icon
            });
          }
        }).addTo(map);

        // Search box for hospital finder
        var arcgisOnline = L.esri.Geocoding.arcgisOnlineProvider({
          apiKey: apiKey
        });

        var hospitalProvider = L.esri.Geocoding.featureLayerProvider({
          url: "https://services8.arcgis.com/mpSDBlkEzjS62WgX/ArcGIS/rest/services/Daftar_RumahSakitDKI_JAKARTA_cleansed/FeatureServer/0",
          searchFields:['NAMA_PPK'],
          label: 'Hospital Location',
          bufferRadius: 100,
          formatSuggestion: function (feature) {
            return feature.properties.NAMA_PPK
          }
        });

        L.esri.Geocoding.geosearch({
          placeholder: "Masukkan nama faskes yang ingin anda cari",
          providers: [hospitalProvider]
        }).addTo(map);

        // // Search box
        // const searchControl = L.esri.Geocoding.geosearch({
        //   position: "topleft",
        //   placeholder: "Masukkan alamat yang ingin anda cari",
        //   useMapBounds: false,
        //   providers: [L.esri.Geocoding.arcgisOnlineProvider({
        //     apikey: apiKey,
        //     nearby: {
        //       lat: -33.8688,
        //       lng: 151.2093
        //     },
        //   })]
        // }).addTo(map);

        // const results = L.layerGroup().addTo(map);

        // searchControl.on("results", (data) => {
        //   results.clearLayers();
        //   for (let i = data.results.length - 1; i >= 0; i--) {
        //     const lngLatString = `${Math.round(data.results[i].latlng.lng * 100000)/100000}, ${Math.round(data.results[i].latlng.lat * 100000)/100000}`;
        //     const marker = L.marker(data.results[i].latlng);
        //     marker.bindPopup(`<b>${lngLatString}</b><p>${data.results[i].properties.LongLabel}</p>`)
        //     results.addLayer(marker);
        //     marker.openPopup();
        //   }
        // });

        // Add a DOM Node to display the text routing directions
        const directions = document.createElement("div");
        directions.id = "directions";
        directions.innerHTML = "Klik pada peta untuk membuat rute asal dan destinasi anda.";
        document.body.appendChild(directions);

        // Layer Group for start/end-points
        const startLayerGroup = L.layerGroup().addTo(map);
        const endLayerGroup = L.layerGroup().addTo(map);

        // Layer Group for route lines
        const routeLines = L.layerGroup().addTo(map);

        let currentStep = "start";
        let startCoords, endCoords;

        function updateRoute() {
          // Create the arcgis-rest-js authentication object to use later.
          const authentication = new arcgisRest.ApiKey({
            key: apiKey
          });

          // make the API request
          arcgisRest
            .solveRoute({
              stops: [startCoords, endCoords],
              endpoint: "https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World/solve",
              authentication
            })
            .then((response) => {
              // Show the result route on the map.
              routeLines.clearLayers();
              L.geoJSON(response.routes.geoJson).addTo(routeLines);

              // Show the result text directions on the map.
              const directionsHTML = response.directions[0].features.map((f) => f.attributes.text).join("<br/>");
              directions.innerHTML = directionsHTML;
              startCoords = null;
              endCoords = null;
            })
            .catch((error) => {
              console.error(error);
              alert("There was a problem using the route service. See the console for details.");
            });
        }

        // When the map is clicked, get the coordinates, store the start or end
        // state, and pass them to the updateRoute function which calls the REST endpoint.
        map.on("click", (e) => {
          const coordinates = [e.latlng.lng, e.latlng.lat];

          if (currentStep === "start") {
            startLayerGroup.clearLayers();
            endLayerGroup.clearLayers();
            routeLines.clearLayers();
            L.marker(e.latlng).addTo(startLayerGroup);
            startCoords = coordinates;
            currentStep = "end";
          } else {
            L.marker(e.latlng).addTo(endLayerGroup);
            endCoords = coordinates;
            currentStep = "start";
          }

          if (startCoords && endCoords) {
            updateRoute();
          }
        });

        // Setup the Popup
        hospital_jkt.bindPopup(function (layer) {
          return L.Util.template('<b>Faskes : {NAMA_PPK}</b><br><b>Alamat :</b> {ALAMAT_PPK}</br><br><b>Kontak :</b> {CONTACT_PERSON}</br><br><b>Jenis Faskes :</b> {JENIS_FASKES}</br>', layer.feature.properties);
        });

        L.control.scale({
          metric: true,
          imperial: false,
          position: 'bottomright'
        }).addTo(map);

        // Logo position: bottomright, topright, topleft, bottomleft
        L.Control.Watermark=L.Control.extend({
          onAdd:function(map){
            var img = L.DomUtil.create('img');
            img.src = 'https://dl.dropboxusercontent.com/s/cmpav45twx8t5x6/getridcovid_logo.png';
            img.style.width = '100px';
            return img;
          },
          onRemove:function(map){},
        });

        L.control.watermark = function(opts){
          return new L.Control.Watermark(opts);
        }

        L.control.watermark({position:'bottomleft'}).addTo(map);

    </script>
</body>
</html>